name: Build and Publish

on:
  schedule:
  # Run on the 1st and 15th of every month (≈ every 2 weeks)
  - cron: "0 6 1,15 * *"
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild even if the kubeconform version tag already exists"
        required: false
        type: boolean
        default: true # we want to update the kustomize version, image packages and schemas even if kubeconform's version hasn't changed

permissions:
  contents: write # create releases
  packages: write # push to ghcr.io

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ── Checkout ────────────────────────────────────────────────────────────
    - name: Checkout repository
      uses: actions/checkout@v4

    # ── Resolve tool versions ────────────────────────────────────────────────
    - name: Get latest kubeconform version
      id: kubeconform
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        VERSION=$(gh release view --repo yannh/kubeconform --json tagName -q .tagName)
        echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
        echo "kubeconform: ${VERSION}"

    - name: Get latest kustomize version
      id: kustomize
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        VERSION=$(gh api repos/kubernetes-sigs/kustomize/releases \
          --jq '[.[] | select(.tag_name | startswith("kustomize/")) | select(.prerelease == false)] | first | .tag_name | ltrimstr("kustomize/")')
        echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
        echo "kustomize: ${VERSION}"

    # ── Skip guard ───────────────────────────────────────────────────────────
    - name: Check whether this release tag already exists
      id: check
      env:
        GH_TOKEN: ${{ github.token }}
        TAG: ${{ steps.kubeconform.outputs.version }}
      run: |
        if gh release view "${TAG}" --repo "${{ github.repository }}" > /dev/null 2>&1; then
          echo "exists=true" >> "$GITHUB_OUTPUT"
          echo "Release ${TAG} already exists – skipping (use force_rebuild to override)"
        else
          echo "exists=false" >> "$GITHUB_OUTPUT"
          echo "Release ${TAG} not found – proceeding with build"
        fi

    # All subsequent steps are skipped when the tag exists unless force_rebuild=true.
    # The condition is evaluated once and reused via a job-level env.
    - name: Determine whether to proceed
      id: gate
      run: |
        if [ "${{ steps.check.outputs.exists }}" = "false" ] || [ "${{ inputs.force_rebuild }}" = "true" ]; then
          echo "proceed=true" >> "$GITHUB_OUTPUT"
        else
          echo "proceed=false" >> "$GITHUB_OUTPUT"
        fi

    # ── Docker build & push ──────────────────────────────────────────────────
    - name: Set up Docker Buildx
      if: steps.gate.outputs.proceed == 'true'
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      if: steps.gate.outputs.proceed == 'true'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract Docker metadata
      if: steps.gate.outputs.proceed == 'true'
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=raw,value=${{ steps.kubeconform.outputs.version }}
          type=raw,value=latest
        labels: |
          org.opencontainers.image.version=${{ steps.kubeconform.outputs.version }}
          dev.kubeconform-offline.kustomize-version=${{ steps.kustomize.outputs.version }}

    - name: Build and push image
      if: steps.gate.outputs.proceed == 'true'
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        build-args: |
          KUBECONFORM_VERSION=${{ steps.kubeconform.outputs.version }}
          KUSTOMIZE_VERSION=${{ steps.kustomize.outputs.version }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # ── GitHub Release ───────────────────────────────────────────────────────
    - name: Create GitHub Release
      if: steps.gate.outputs.proceed == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
        TAG: ${{ steps.kubeconform.outputs.version }}
        KUSTOMIZE_VERSION: ${{ steps.kustomize.outputs.version }}
        IMAGE: ghcr.io/${{ github.repository }}
      run: |
        cat > /tmp/release-notes.md << EOF
        ## Bundled tools

        | Tool | Version |
        |------|---------|
        | [kubeconform](https://github.com/yannh/kubeconform) | \`${TAG}\` |
        | [kustomize](https://github.com/kubernetes-sigs/kustomize) | \`${KUSTOMIZE_VERSION}\` |

        ## Bundled Kubernetes JSON schemas

        The latest patch release for each minor version is included (both
        \`standalone\` and \`standalone-strict\` variants):

        - v1.31, v1.32, v1.33, v1.34, v1.35

        Schemas are sourced from
        [yannh/kubernetes-json-schema](https://github.com/yannh/kubernetes-json-schema).

        ## Container image

        \`\`\`
        ${IMAGE}:${TAG}
        ${IMAGE}:latest
        \`\`\`

        ## Usage in GitLab CI

        \`\`\`yaml
        validate:
          image: ${IMAGE}:${TAG}
          script:
            - kubeconform
                -kubernetes-version 1.33.0
                -schema-location "\$SCHEMA_LOCATION"
                -summary
                manifests/
        \`\`\`

        \`\`\`yaml
        # Combined kustomize + kubeconform pipeline
        validate:
          image: ${IMAGE}:${TAG}
          entrypoint: [""]
          script:
            - kustomize build overlays/production |
                kubeconform
                  -kubernetes-version 1.33.0
                  -schema-location "\$SCHEMA_LOCATION"
                  -summary -
        \`\`\`

        The \`\$SCHEMA_LOCATION\` environment variable is pre-set in the image to:
        \`\`\`
        /schemas/{{.NormalizedKubernetesVersion}}-standalone{{.StrictSuffix}}/{{.ResourceKind}}{{.KindSuffix}}.json
        \`\`\`
        EOF

        gh release delete "${TAG}" --yes --repo "${{ github.repository }}" 2>/dev/null || true

        gh release create "${TAG}" \
          --repo "${{ github.repository }}" \
          --title "kubeconform ${TAG}" \
          --notes-file /tmp/release-notes.md
